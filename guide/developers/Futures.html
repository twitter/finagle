
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Twitter Futures &#8212; Finagle 24.2.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/finagle.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Signaling Failure within Finagle" href="SignalingFailure.html" />
    <link rel="prev" title="Extending Finagle" href="Extending.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="SignalingFailure.html" title="Signaling Failure within Finagle"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Extending.html" title="Extending Finagle"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Finagle</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Twitter Futures</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="twitter-futures">
<h1>Twitter Futures<a class="headerlink" href="#twitter-futures" title="Permalink to this headline">¶</a></h1>
<section id="history">
<h2>History<a class="headerlink" href="#history" title="Permalink to this headline">¶</a></h2>
<p>Futures represent asynchronous values.  Over time, the java community has experimented with a few
different styles of working with them, starting with transforming them to synchronous code, where
you would block until the future was satisfied.  We can see remnants of this in the old
java.util.concurrent.Future interface, where the only way of using the result of a future is
Future#get, which blocks until the future returns.  We can do somewhat better by polling until the
future is satisfied, and doing other things in the mean time, but this is manual.  Instead of
managing it manually, we could use Future#get exclusively, which would force us to use a thread per
concurrent request.</p>
<p>We wanted to try using an evented system instead, so we chose to describe what we want to do after
we get a response, effectively a closure.  This is a common API for asynchronous results, so it’s a
natural match for asynchronous values.  Scala had a Futures implementation, <cite>scala.actors.Future</cite>,
but it was tightly coupled to their Actors library, which needed some work.  We ended up working on
our own Futures implementation, which turned into Twitter Futures.  Around the same time, Akka was
working on an actors implementation, and produced their own Futures implementation, which turned
into the <cite>scala.concurrent.Future</cite>.  More recently, Java came out with their own Future which you
can attach closures to, <cite>java.util.concurrent.CompletableFuture</cite>.</p>
</section>
<section id="scheduling">
<h2>Scheduling<a class="headerlink" href="#scheduling" title="Permalink to this headline">¶</a></h2>
<p>Each of the modern Futures implementations, Scala, Java, and Twitter, represents a different way of
scheduling the closures that should run on satisfaction.</p>
<p>It’s worth noting that our scheduler is configurable (this is also true for Scala Futures, on a
more granular basis), so this model isn’t set in stone.  With that said, we often unthinkingly
program against the semantics of the default scheduler, so it would be a significant undertaking to
change the scheduler.</p>
<dl class="simple">
<dt>Scala</dt><dd><p>Someone else run this.  Typically this means that we schedule the closure to be run in a thread
pool somewhere.  This has the advantage that there’s a fixed cost of satisfying a future per
closure hanging off of it, which is just the cost of scheduling each closure.  It can also allow
parallelism if you’re doing CPU-intensive work, and is kinder to blocking work.  The
disadvantage is that it requires doing the work on another thread, and comes with all of the
costs of passing the message to the other thread.  The way work gets scheduled in Scala can be
changed on a per-closure basis, but the default is to be backed by a thread pool.</p>
</dd>
<dt>Java</dt><dd><p>I’ll run this now.  This can be good for caching behavior, and lets us get better stack traces,
because we can see the causal link between satisfying a Future and running the closures.  The
disadvantage is that this is no longer stack-safe, because hanging subsequent closures off will
deepen the stack.  Note that at each point of asynchrony, the stack trace is broken.</p>
</dd>
<dt>Twitter</dt><dd><p>I’ll run this later.  This still helps with caching, but can be stack-safe.  The disadvantage is
that the stack traces aren’t as useful (in practice we sometimes “run it now”).</p>
</dd>
</dl>
<p>To illustrate this, imagine that we’re doing three pieces of work, doWorkA, doWorkB, doWorkC.</p>
<p>We write it as:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Future.value(doWorkA()).map { a =&gt; doWorkB(a) }.map { b =&gt; doWorkC(b) }
</pre></div>
</div>
<p>So what does this turn into at run time?  The answer is different depending upon which model we have for Future.</p>
<p>With Scala, it becomes:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>val executor = new ForkJoinPool(2 /* parallelism */)
val a = doWorkA()
executor.submit(new Runnable() { def run(): Unit = {
  val b = doWorkB(a)
  executor.submit(new Runnable() { def run(): Unit = doWorkC(b) })
})
</pre></div>
</div>
<p>With Java, it becomes:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>def workA(): C = {
  val a = doWorkA()
  workB(a)
}
def workB(a: A): C = {
  val b = doWorkB(a)
  workC(b)
}
def workC(b): C = {
  doWorkC(b)
}
workA()
</pre></div>
</div>
<p>With Twitter, it becomes:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>val a = doWorkA()
val b = doWorkB(a)
doWorkC(b)
</pre></div>
</div>
<p>We’ve chosen this style for performance and for stack safety, and have been quite happy with it
historically.</p>
</section>
<section id="interruption">
<h2>Interruption<a class="headerlink" href="#interruption" title="Permalink to this headline">¶</a></h2>
<p>The other main difference that the different future types have is how they deal with cancellation.
It can be useful to cancel asynchronous work to free up the resources, even though the thread itself
is not blocked, for example if you’re consuming resources on a remote host.  Note that this breaks
the model of what a Future is, since it represents an asynchronous value.  Being able to cancel to
prevent work points out that the asynchronous work must be happening somewhere, and asks the future
to keep a reference to where that work is being done, so it can be cancelled.  Scala simply doesn’t
implement cancellation, so that if you want to support it, you need to handle it in another way.
Java only supports cancellation by immediately satisfying the future with CancellationException.  If
you want to subsequently cancel the work, you need to ensure that that Future handles the
CancellationException gracefully.  Twitter futures allow users to set interrupt handlers, and can
propagate interruptions up the flatMap chain, so that if a future is no longer needed, it can cancel
the underlying work that will later produce that future.  This means that futures do the right thing
by default, and we don’t need to treat each Future#flatMap specially to propagate interrupts.
Interruptions are also advisory for Twitter futures, so that we can choose to ignore them if we
wish.  One nice thing about this style is that it’s analogous to the Java interrupt mechanism, where
we in effect set a field that an implementor can choose to respect or not.</p>
</section>
<section id="guts">
<h2>Guts<a class="headerlink" href="#guts" title="Permalink to this headline">¶</a></h2>
<p>There are two main implementations of Twitter future, which are <cite>ConstFuture</cite> and <cite>Promise</cite>.
<cite>ConstFuture</cite> is an already satisfied future–effectively a thin wrapper around a <cite>Try</cite>.  <cite>Promise</cite>
is what most real futures in the wild are, something that starts unsatisfied and gets satisfied
later.  <cite>Promise</cite> uses a state machine, which can be in one of a few different states, Waiting,
Interruptible, Transforming, Interrupted, Linked, and Done.  New <cite>Promises</cite> start in Waiting, and
all of them are unsatisfied except for Done.  You can move from Waiting to Interruptible by calling
<cite>Promise#setInterruptHandler</cite>.  If a <cite>Promise</cite> is constructed with a <cite>Future#transform</cite> method (like
<cite>Future#flatMap</cite>, or <cite>Future#rescue</cite>) it’s in Transforming mode.  If a promise is interrupted when
Interruptible, it fires the interrupt handler, and moves to the Interrupted state.  If it’s
interrupted when Transforming, it delegates the interrupt to the underlying Future, and moves to the
Interrupted state.  When a future is constructed with a <cite>Future#transform</cite> method and the underlying
future has been satisfied, but the newly constructed one hasn’t yet, the <cite>Promise</cite> moves to the
Linked state, where it delegates all work to the new constructed one.  This allows infinite future
recursion without space leaks, which is quite neat.  Scala 2.12 futures have since used our trick to
do it themselves, so they can also do recursion without space leaks.  <cite>Promise#updateIfEmpty</cite> and
its derivatives, like <cite>Promise#setValue</cite>, will move a <cite>Promise</cite> from any state to Done, if they are
not already satisfied, at which point its closures will be submitted to the scheduler to be run by
the calling thread that satisfied the <cite>Promise</cite>.</p>
</section>
<section id="detachable">
<h2>Detachable<a class="headerlink" href="#detachable" title="Permalink to this headline">¶</a></h2>
<p>When more than one execution dependency depends on the result of a future, it can be dangerous to
interrupt it, since you might inadvertently fail other folks’ work.  However, if you never interrupt
it, you can end up with memory leaks if the future is never satisfied and we continuously add work
to it.  Detachable Promises are an attempt to fix this, so that we can mark promises as “may not be
needed later, though the underlying future they depend on will be useful”, and must be
constructed explicitly by saying <cite>Promise.attached(underlying)</cite> like <a class="reference external" href="https://github.com/twitter/finagle/blob/2ae7cdd6124d5d10c9bcbf7c68a0ef2784abf968/finagle-core/src/main/scala/com/twitter/finagle/service/DelayedFactory.scala#L34">here</a>.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="../index.html">
  <img class="logo" src="../_static/logo_small.png" alt="Logo"/>
</a></p><a href="index.html"><h3>Finagle</h3></a>
<p>
  Finagle is a network stack for distributed systems.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://github.com/twitter/finagle">Finagle @ GitHub</a></li>
  <li><a href="https://github.com/twitter/finagle/issues">Issue Tracker</a></li>
</ul>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Twitter Futures</a><ul>
<li><a class="reference internal" href="#history">History</a></li>
<li><a class="reference internal" href="#scheduling">Scheduling</a></li>
<li><a class="reference internal" href="#interruption">Interruption</a></li>
<li><a class="reference internal" href="#guts">Guts</a></li>
<li><a class="reference internal" href="#detachable">Detachable</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="Extending.html" title="previous chapter">Extending Finagle</a></li>
      <li>Next: <a href="SignalingFailure.html" title="next chapter">Signaling Failure within Finagle</a></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">&copy; Copyright 2024 Twitter, Inc.</div>
  
  </body>
</html>