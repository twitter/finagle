
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Protocols &#8212; Finagle 24.2.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/finagle.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Metrics" href="Metrics.html" />
    <link rel="prev" title="Names and Naming in Finagle" href="Names.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="Metrics.html" title="Metrics"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Names.html" title="Names and Naming in Finagle"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Finagle</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Protocols</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="protocols">
<h1>Protocols<a class="headerlink" href="#protocols" title="Permalink to this headline">¶</a></h1>
<p>The core of Finagle is protocol-agnostic, meaning its internals provide an
extensible RPC subsystem without defining any details of specific
client-server protocols. Thus in order to provide usable APIs for clients and
servers, there are a number of Finagle subprojects that implement common
protocols. A few of these protocol implementations are documented below.</p>
<section id="thrift">
<span id="thrift-and-scrooge"></span><h2>Thrift<a class="headerlink" href="#thrift" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://thrift.apache.org/">Apache Thrift</a> is an interface definition
language. With its associated code generator(s) and binary communication
protocol, Thrift facilitates the development of scalable RPC systems. By
“scalable”, we specifically mean that IDLs can be shared, allowing developers
to define schemas and expose network services that clients access using code
generated for their preferred programming language.</p>
<p>The IDL is the core of Thrift. IDLs provide clear service specifications that we
can use to implement clients and servers. This means that different
implementations of servers can be swapped out transparently, since they all
expose the same interface, regardless of language.</p>
<p>Thrift was originally built at Facebook. For more details on the original design,
check out the <a class="reference external" href="https://thrift.apache.org/static/files/thrift-20070401.pdf">whitepaper</a>.</p>
<p><cite>finagle-thrift</cite> is used extensively within Twitter, but to meet the needs of our
service-oriented architecture we had to extend the Thrift protocol. We
introduced the notion of “Twitter-upgraded Thrift”, or TTwitter, which augments
the protocol with support for our internal infrastructure. Specifically, we tack
on a request header containing tracing info, Finagle ClientId strings, and
Wily delegations. In order to maintain backwards compatibility, TTwitter clients
perform protocol negotiation upon connection and will downgrade to raw TBinary
Thrift if servers are not using the upgraded protocol. By default, <cite>finagle-thrift</cite>
uses the Thrift framed codec and the binary protocol for serialization.</p>
<blockquote>
<div><p>negotiation well. If your client should run into this, you can disable
it by calling <code class="docutils literal notranslate"><span class="pre">Thrift.client.withNoAttemptTTwitterUpgrade</span></code>.</p>
</div></blockquote>
<section id="using-finagle-thrift">
<h3>Using finagle-thrift<a class="headerlink" href="#using-finagle-thrift" title="Permalink to this headline">¶</a></h3>
<p>At Twitter, we use our open-source Thrift code-generator called
<a class="reference external" href="https://twitter.github.io/scrooge/">Scrooge</a>. Scrooge is written in Scala and
can generate source code in Scala or Java. Given the following IDL:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>service LoggerService {
  string log(1: string message, 2: i32 logLevel) throws (1: WriteException writeEx);
  i32 getLogSize() throws (1: ReadException readEx);
}
</pre></div>
</div>
<p>Scrooge will generate code that can be used by <cite>finagle-thrift</cite> with the
following rich APIs:</p>
<p id="finagle-thrift-server">Serving the IDL:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span> <span class="n">server</span><span class="p">:</span> <span class="nc">ListeningServer</span> <span class="o">=</span> <span class="nc">Thrift</span><span class="p">.</span><span class="n">server</span><span class="p">.</span><span class="n">serveIface</span><span class="p">(</span>
  <span class="s">&quot;localhost:1234&quot;</span><span class="p">,</span>
  <span class="k">new</span> <span class="nc">LoggerService</span><span class="p">.</span><span class="nc">MethodPerEndpoint</span> <span class="p">{</span>
    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">logLevel</span><span class="p">:</span> <span class="nc">Int</span><span class="p">):</span> <span class="nc">Future</span><span class="p">[</span><span class="nc">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">println</span><span class="p">(</span><span class="s">s&quot;[</span><span class="si">$</span><span class="n">logLevel</span><span class="s">] Server received: &#39;</span><span class="si">$</span><span class="n">message</span><span class="s">&#39;&quot;</span><span class="p">)</span>
      <span class="nc">Future</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="s">s&quot;You&#39;ve sent: (&#39;</span><span class="si">$</span><span class="n">message</span><span class="s">&#39;, </span><span class="si">$</span><span class="n">logLevel</span><span class="s">)&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">// getLogSize throws ReadExceptions every other request.</span>
    <span class="k">def</span> <span class="nf">getLogSize</span><span class="p">():</span> <span class="nc">Future</span><span class="p">[</span><span class="nc">Int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">s&quot;Server: getLogSize ReadException&quot;</span><span class="p">)</span>
        <span class="nc">Future</span><span class="p">.</span><span class="n">exception</span><span class="p">(</span><span class="k">new</span> <span class="nc">ReadException</span><span class="p">())</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">println</span><span class="p">(</span><span class="s">s&quot;Server: getLogSize Success&quot;</span><span class="p">)</span>
        <span class="nc">Future</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p id="finagle-thrift-client">Construct a client:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span> <span class="n">clientServicePerEndpoint</span><span class="p">:</span> <span class="nc">LoggerService</span><span class="p">.</span><span class="nc">ServicePerEndpoint</span> <span class="o">=</span>
  <span class="nc">Thrift</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">servicePerEndpoint</span><span class="p">[</span><span class="nc">LoggerService</span><span class="p">.</span><span class="nc">ServicePerEndpoint</span><span class="p">](</span>
    <span class="s">&quot;localhost:1234&quot;</span><span class="p">,</span>
    <span class="s">&quot;thrift_client&quot;</span>
  <span class="p">)</span>
</pre></div>
</div>
<p>A <cite>ServicePerEndpoint</cite> is a collection of <cite>Services</cite>, one for each Thrift method. Call the <cite>log</cite> method:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span> <span class="n">result</span><span class="p">:</span> <span class="nc">Future</span><span class="p">[</span><span class="nc">Log</span><span class="p">.</span><span class="nc">SuccessType</span><span class="p">]</span> <span class="o">=</span> <span class="n">clientServicePerEndpoint</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="nc">Log</span><span class="p">.</span><span class="nc">Args</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>Thrift <cite>Services</cite> can be combined with <a class="reference external" href="https://twitter.github.io/finagle/docs/com/twitter/finagle/Filter$">Filters</a>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span> <span class="n">uppercaseFilter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleFilter</span><span class="p">[</span><span class="nc">Log</span><span class="p">.</span><span class="nc">Args</span><span class="p">,</span> <span class="nc">Log</span><span class="p">.</span><span class="nc">SuccessType</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span>
    <span class="n">req</span><span class="p">:</span> <span class="nc">Log</span><span class="p">.</span><span class="nc">Args</span><span class="p">,</span>
    <span class="n">service</span><span class="p">:</span> <span class="nc">Service</span><span class="p">[</span><span class="nc">Log</span><span class="p">.</span><span class="nc">Args</span><span class="p">,</span> <span class="nc">Log</span><span class="p">.</span><span class="nc">SuccessType</span><span class="p">]</span>
  <span class="p">):</span> <span class="nc">Future</span><span class="p">[</span><span class="nc">Log</span><span class="p">.</span><span class="nc">SuccessType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="n">uppercaseRequest</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">message</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">toUpperCase</span><span class="p">)</span>
    <span class="n">service</span><span class="p">(</span><span class="n">uppercaseRequest</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">timeoutFilter</span><span class="p">[</span><span class="nc">Req</span><span class="p">,</span> <span class="nc">Rep</span><span class="p">](</span><span class="n">duration</span><span class="p">:</span> <span class="nc">Duration</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="n">exc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IndividualRequestTimeoutException</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
  <span class="kd">val</span> <span class="n">timer</span> <span class="o">=</span> <span class="nc">DefaultTimer</span>
  <span class="k">new</span> <span class="nc">TimeoutFilter</span><span class="p">[</span><span class="nc">Req</span><span class="p">,</span> <span class="nc">Rep</span><span class="p">](</span><span class="n">duration</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">timer</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">val</span> <span class="n">filteredLog</span><span class="p">:</span> <span class="nc">Service</span><span class="p">[</span><span class="nc">Log</span><span class="p">.</span><span class="nc">Args</span><span class="p">,</span> <span class="nc">Log</span><span class="p">.</span><span class="nc">SuccessType</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeoutFilter</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="n">seconds</span><span class="p">)</span>
  <span class="p">.</span><span class="n">andThen</span><span class="p">(</span><span class="n">uppercaseFilter</span><span class="p">)</span>
  <span class="p">.</span><span class="n">andThen</span><span class="p">(</span><span class="n">clientServicePerEndpoint</span><span class="p">.</span><span class="n">log</span><span class="p">)</span>

<span class="n">filteredLog</span><span class="p">(</span><span class="nc">Log</span><span class="p">.</span><span class="nc">Args</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="c1">// [2] Server received: &#39;HELLO&#39;</span>
</pre></div>
</div>
<p>Here’s an example of a retry policy that retries on Thrift exceptions:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span> <span class="n">retryPolicy</span><span class="p">:</span> <span class="nc">RetryPolicy</span><span class="p">[</span><span class="nc">Try</span><span class="p">[</span><span class="nc">GetLogSize</span><span class="p">.</span><span class="nc">Result</span><span class="p">]]</span> <span class="o">=</span>
  <span class="nc">RetryPolicy</span><span class="p">.</span><span class="n">tries</span><span class="p">[</span><span class="nc">Try</span><span class="p">[</span><span class="nc">GetLogSize</span><span class="p">.</span><span class="nc">Result</span><span class="p">]](</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="nc">Throw</span><span class="p">(</span><span class="n">ex</span><span class="p">:</span> <span class="nc">ReadException</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kc">true</span>
    <span class="p">})</span>

<span class="kd">val</span> <span class="n">retriedGetLogSize</span><span class="p">:</span> <span class="nc">Service</span><span class="p">[</span><span class="nc">GetLogSize</span><span class="p">.</span><span class="nc">Args</span><span class="p">,</span> <span class="nc">GetLogSize</span><span class="p">.</span><span class="nc">SuccessType</span><span class="p">]</span> <span class="o">=</span>
  <span class="k">new</span> <span class="nc">RetryExceptionsFilter</span><span class="p">(</span><span class="n">retryPolicy</span><span class="p">,</span> <span class="nc">DefaultTimer</span><span class="p">)</span>
    <span class="p">.</span><span class="n">andThen</span><span class="p">(</span><span class="n">clientServicePerEndpoint</span><span class="p">.</span><span class="n">getLogSize</span><span class="p">)</span>

<span class="n">retriedGetLogSize</span><span class="p">(</span><span class="nc">GetLogSize</span><span class="p">.</span><span class="nc">Args</span><span class="p">())</span>
</pre></div>
</div>
<p>Another way to construct Thrift clients is using the <cite>MethodPerEndpoint</cite> interface:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span> <span class="n">client</span><span class="p">:</span> <span class="nc">LoggerService</span><span class="p">.</span><span class="nc">MethodPerEndpoint</span> <span class="o">=</span>
  <span class="nc">Thrift</span><span class="p">.</span><span class="n">client</span><span class="p">.</span><span class="n">build</span><span class="p">[</span><span class="nc">LoggerService</span><span class="p">.</span><span class="nc">MethodPerEndpoint</span><span class="p">](</span><span class="s">&quot;localhost:1234&quot;</span><span class="p">)</span>
<span class="n">client</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;message&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">).</span><span class="n">onSuccess</span> <span class="p">{</span> <span class="n">response</span> <span class="o">=&gt;</span>
  <span class="n">println</span><span class="p">(</span><span class="s">&quot;Client received response: &quot;</span> <span class="o">+</span> <span class="n">response</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To convert the Service interface to the method interface use <a class="reference external" href="https://twitter.github.io/finagle/docs/com/twitter/finagle/Thrift$">Thrift.Client.methodPerEndpoint</a>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span> <span class="n">filteredMethodIface</span><span class="p">:</span> <span class="nc">LoggerService</span><span class="p">.</span><span class="nc">MethodPerEndpoint</span> <span class="o">=</span>
  <span class="nc">Thrift</span><span class="p">.</span><span class="nc">Client</span><span class="p">.</span><span class="n">methodPerEndpoint</span><span class="p">(</span><span class="n">clientServicePerEndpoint</span><span class="p">.</span><span class="n">withLog</span><span class="p">(</span><span class="n">filteredLog</span><span class="p">))</span>
<span class="nc">Await</span><span class="p">.</span><span class="n">result</span><span class="p">(</span><span class="n">filteredMethodIface</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">&quot;ping&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="n">println</span><span class="p">))</span>
</pre></div>
</div>
<p>The complete example is at <a class="reference external" href="https://github.com/twitter/finagle/blob/develop/finagle-example/src/main/scala/com/twitter/finagle/example/thrift/ThriftServicePerEndpointExample.scala">ThriftServicePerEndpointExample.scala</a>.
Check out the <cite>finagle-thrift</cite> <a class="reference external" href="https://twitter.github.io/finagle/docs/com/twitter/finagle/Thrift$">API</a>
for more info.</p>
</section>
</section>
<section id="mux">
<span id="id1"></span><h2>Mux<a class="headerlink" href="#mux" title="Permalink to this headline">¶</a></h2>
<p><strong>What is Mux?</strong></p>
<p>At its core, Mux is a generic RPC multiplexing protocol. Although its primary
implementation is as a Finagle﻿ subproject, Mux is not Finagle-specific. In the
same way that HTTP is an application-layer protocol with ﻿﻿﻿numerous implementations
in a variety of languages, Mux is a session-layer protocol with a Scala
implementation in the finagle-mux package. Also since it is a purely
session-layer protocol, Mux can be used in conjunction with protocols from other
layers of the <a class="reference external" href="https://en.wikipedia.org/wiki/OSI_model">OSI</a> model. For example,
Finagle currently has an implementation of the Thrift protocol on top of Mux,
available in the <cite>finagle-thriftmux</cite> package.</p>
<p>Much of the future work on Finagle will involve improvements to Mux and feature
development targeting services that support it. The wire format and semantics of
the Mux protocol are documented in <a class="reference external" href="https://github.com/twitter/finagle/blob/release/finagle-mux/src/main/scala/com/twitter/finagle/mux/package.scala">its source
code</a>.</p>
<p><strong>Why is RPC multiplexing important?</strong></p>
<p>Some important consequences of multiplexing at the RPC level:</p>
<ul class="simple">
<li><p>One network connection per client-server session</p></li>
<li><p>Maximization of available bandwidth without incurring the cost of opening
additional sockets</p></li>
<li><p>Elimination of head-of-line blocking</p></li>
<li><p>Explicit queue management</p></li>
</ul>
<p><strong>Mux as a pure session-layer protocol</strong></p>
<p>In OSI terminology, Mux is a pure
session layer protocol. As such, it provides a rich set of session control
features:</p>
<p><em>Session Liveness Detection</em></p>
<p>In the past, Finagle has relied on mechanisms like failure accrual to detect the
health of an endpoint. These mechanisms require configuration which tended to
vary across disparate services and endpoints. Mux introduces a principled way to
gauge session health via ping messages. This allows Finagle to provide more
generic facilities for liveness detection that require little-to-no
configuration.</p>
<p><em>Request Cancellation</em></p>
<p>Without proper protocol support, request cancellation in Finagle has historically
been difficult to implement efficiently. For example, something as simple as
timing out a request requires closing its TCP connection. Mux gives us granular
control over request cancellation without having to go so far as to terminate a
session.</p>
<p><em>Ability to advertise session windows</em></p>
<p>Mux enables servers to advertise availability on a per-window basis. This is
useful for establishing explicit queueing policies, leading the way to
intelligent back-pressure, slow start, and GC-avoidance.</p>
</section>
<section id="mysql">
<h2>Mysql<a class="headerlink" href="#mysql" title="Permalink to this headline">¶</a></h2>
<p><em>finagle-mysql</em> is an asynchronous implementation of the MySQL protocol built on top of Finagle.
The project provides a simple query API with support for prepared statements and
transactions while taking advantage of Finagle’s <a class="reference internal" href="Clients.html#client-modules"><span class="std std-ref">client stack</span></a> for
connection pooling. The implementation supports both the MySQL binary and string protocols.</p>
<p>A client can be constructed using the
<a class="reference external" href="https://twitter.github.io/finagle/docs/com/twitter/finagle/Mysql$">Mysql</a> protocol object:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span> <span class="n">client</span> <span class="o">=</span> <span class="nc">Mysql</span><span class="p">.</span><span class="n">client</span>
  <span class="p">.</span><span class="n">withCredentials</span><span class="p">(</span><span class="s">&quot;&lt;user&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;&lt;password&gt;&quot;</span><span class="p">)</span>
  <span class="p">.</span><span class="n">withDatabase</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>
  <span class="p">.</span><span class="n">configured</span><span class="p">(</span><span class="nc">DefaultPool</span>
    <span class="p">.</span><span class="nc">Param</span><span class="p">(</span><span class="n">low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">idleTime</span> <span class="o">=</span> <span class="mi">5</span><span class="p">.</span><span class="n">minutes</span><span class="p">,</span> <span class="n">bufferSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">maxWaiters</span> <span class="o">=</span> <span class="nc">Int</span><span class="p">.</span><span class="nc">MaxValue</span><span class="p">))</span>
  <span class="p">.</span><span class="n">newClient</span><span class="p">(</span><span class="s">&quot;127.0.0.1:3306&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We configure the <a class="reference external" href="https://twitter.github.io/finagle/docs/com/twitter/finagle/client/DefaultPool">client’s connection pool</a> to be
compatible with our MySQL server. The constructor returns a Finagle <a class="reference internal" href="ServicesAndFilters.html#service-factory"><span class="std std-ref">ServiceFactory</span></a>
from <a class="reference external" href="https://twitter.github.io/finagle/docs/com/twitter/finagle/mysql/Request">mysql.Request</a> to <a class="reference external" href="https://twitter.github.io/finagle/docs/com/twitter/finagle/mysql/Result">mysql.Result</a>
which we can use to query the db:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span> <span class="n">product</span> <span class="o">=</span> <span class="n">client</span><span class="p">().</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">service</span> <span class="o">=&gt;</span>
  <span class="c1">// `service` is checked out from the pool.</span>
  <span class="n">service</span><span class="p">(</span><span class="nc">QueryRequest</span><span class="p">(</span><span class="s">&quot;SELECT 5*5 AS `product`&quot;</span><span class="p">))</span>
    <span class="p">.</span><span class="n">map</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">rs</span><span class="p">:</span> <span class="nc">ResultSet</span> <span class="o">=&gt;</span> <span class="n">rs</span><span class="p">.</span><span class="n">rows</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">processRow</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">_</span> <span class="o">=&gt;</span> <span class="nc">Seq</span><span class="p">.</span><span class="n">empty</span>
    <span class="p">}.</span><span class="n">ensure</span> <span class="p">{</span>
      <span class="c1">// put `service` back into the pool.</span>
      <span class="n">service</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A <a class="reference external" href="https://twitter.github.io/finagle/docs/com/twitter/finagle/mysql/ResultSet">ResultSet</a> makes it easy to extract
<a class="reference external" href="https://twitter.github.io/finagle/docs/com/twitter/finagle/mysql/Value">Values</a> based on column names. For example, we can
implement the above <cite>processRow</cite> as a pattern match on expected values:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">processRow</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="nc">Row</span><span class="p">):</span> <span class="nc">Option</span><span class="p">[</span><span class="nc">Long</span><span class="p">]</span> <span class="o">=</span>
  <span class="n">row</span><span class="p">.</span><span class="n">getLong</span><span class="p">(</span><span class="s">&quot;product&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The ServiceFactory API gives you more fine-grained control over the pool. This isn’t always necessary
- to simplify <em>finagle-mysql</em> offers a rich API that wraps the ServiceFactory returned from <cite>newClient</cite>:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span> <span class="n">richClient</span> <span class="o">=</span> <span class="nc">Mysql</span><span class="p">.</span><span class="n">client</span>
  <span class="p">.</span><span class="n">withCredentials</span><span class="p">(</span><span class="s">&quot;&lt;user&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;&lt;password&gt;&quot;</span><span class="p">)</span>
  <span class="p">.</span><span class="n">withDatabase</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>
  <span class="p">.</span><span class="n">configured</span><span class="p">(</span><span class="nc">DefaultPool</span>
    <span class="p">.</span><span class="nc">Param</span><span class="p">(</span><span class="n">low</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">idleTime</span> <span class="o">=</span> <span class="mi">5</span><span class="p">.</span><span class="n">minutes</span><span class="p">,</span> <span class="n">bufferSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">maxWaiters</span> <span class="o">=</span> <span class="nc">Int</span><span class="p">.</span><span class="nc">MaxValue</span><span class="p">))</span>
  <span class="p">.</span><span class="n">newRichClient</span><span class="p">(</span><span class="s">&quot;127.0.0.1:3306&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>and we can select:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span> <span class="n">product</span> <span class="o">=</span> <span class="n">richClient</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s">&quot;SELECT 5*5 AS `product`&quot;</span><span class="p">)(</span><span class="n">processRow</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that <cite>select</cite> takes care of checking out the service and returning it to the pool. <cite>select</cite> and
other useful methods are available on <a class="reference external" href="https://twitter.github.io/finagle/docs/com/twitter/finagle/mysql/Client">mysql.Client</a> which is returned
from the call to <cite>newRichClient</cite>.</p>
<p>For a more involved example see the Finagle <a class="reference external" href="https://github.com/twitter/finagle/blob/release/finagle-example/src/main/scala/com/twitter/finagle/example/mysql/Example.scala">example project</a>.</p>
</section>
<section id="http">
<h2>HTTP<a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h2>
<p>Finagle supports both HTTP/1 and HTTP/2. Details can be found in <em>finagle-http</em> and <em>finagle-http2</em>.</p>
<p><strong>Headers</strong></p>
<p>Finagle sets certain request/response headers to transmit additional metadata.</p>
<dl>
<dt><cite>Finagle-Ctx-com.twitter.finagle.Retries</cite></dt><dd><p>The number of times this request has been retried. See <a class="reference external" href="https://github.com/twitter/finagle/blob/release/finagle-http/src/main/scala/com/twitter/finagle/http/codec/HttpContext.scala">HttpContext.scala</a></p>
</dd>
<dt><cite>Finagle-Ctx-com.twitter.finagle.Deadline</cite></dt><dd><p>The time by which this request must be satisfied. See <a class="reference external" href="https://github.com/twitter/finagle/blob/release/finagle-http/src/main/scala/com/twitter/finagle/http/codec/HttpContext.scala">HttpContext.scala</a></p>
</dd>
<dt><cite>dtab-local</cite></dt><dd><p>A list of dtab overrides for this request. Note: if your server accepts requests from untrusted clients, you may want to restrict this header to
only trusted clients. This would prevent bad actors from redirecting requests to possibly unsafe locations. You can disable this behavior by
removing the ServerDtabContextFilter from the server stack, or by adding your own module which removes these headers from untrusted requests.</p>
<p>See <a class="reference external" href="https://github.com/twitter/finagle/blob/release/finagle-http/src/main/scala/com/twitter/finagle/http/codec/HttpDtab.scala">HttpDtab.scala</a> and <a class="reference internal" href="Names.html#dtabs"><span class="std std-ref">dtabs</span></a>.</p>
</dd>
<dt><cite>finagle-http-nack</cite></dt><dd><p>Makes finagle treat this reply as a retryable nack. See <a class="reference external" href="https://github.com/twitter/finagle/blob/release/finagle-base-http/src/main/scala/com/twitter/finagle/http/filter/HttpNackFilter.scala">HttpNackFilter.scala</a></p>
</dd>
<dt><cite>finagle-http-nonretryable-nack</cite></dt><dd><p>Makes finagle treat this reply as a nonretryable nack. See <a class="reference external" href="https://github.com/twitter/finagle/blob/release/finagle-base-http/src/main/scala/com/twitter/finagle/http/filter/HttpNackFilter.scala">HttpNackFilter.scala</a></p>
</dd>
</dl>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="index.html">
  <img class="logo" src="_static/logo_small.png" alt="Logo"/>
</a></p><a href="index.html"><h3>Finagle</h3></a>
<p>
  Finagle is a network stack for distributed systems.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://github.com/twitter/finagle">Finagle @ GitHub</a></li>
  <li><a href="https://github.com/twitter/finagle/issues">Issue Tracker</a></li>
</ul>
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Protocols</a><ul>
<li><a class="reference internal" href="#thrift">Thrift</a><ul>
<li><a class="reference internal" href="#using-finagle-thrift">Using finagle-thrift</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mux">Mux</a></li>
<li><a class="reference internal" href="#mysql">Mysql</a></li>
<li><a class="reference internal" href="#http">HTTP</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="Names.html" title="previous chapter">Names and Naming in Finagle</a></li>
      <li>Next: <a href="Metrics.html" title="next chapter">Metrics</a></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">&copy; Copyright 2024 Twitter, Inc.</div>
  
  </body>
</html>