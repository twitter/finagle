
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Random Aperture &#8212; Finagle 24.2.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/finagle.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">Finagle</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Random Aperture</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="random-aperture">
<h1>Random Aperture<a class="headerlink" href="#random-aperture" title="Permalink to this headline">¶</a></h1>
<p>The Random Aperture load balancer was developed to reduce the number of connections that clients
will establish when talking to large clusters. It does so by selecting a random subset of backends
to talk do under normal conditions with some slight changes under extraordinary conditions. This a
positive effect for both clients and servers by reducing the connections between them but comes with
the cost of load banding. Because clients choose which servers they talk randomly, it’s possible
that some choices of the minimum number of peers to talk to will cause some servers to have more
clients than others. Assuming that clients in a cluster produce the same amount of load, this means
that some servers will have more or less load than others. This makes it harder to reason about a
clusters overall capacity, overload scenarios, and failure modes because servers are no longer
uniformly loaded.</p>
<figure class="align-center" id="id2">
<img alt="../_images/random-aperture.png" src="../_images/random-aperture.png" />
<figcaption>
<p><span class="caption-text">Service A connecting to Service B using random aperture. The number of connections are reduced
but there is an uneven number of connections per service B host due to the statistical nature of
service A picking hosts randomly.</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<section id="minimizing-banding-in-random-aperture">
<h2>Minimizing Banding in Random Aperture<a class="headerlink" href="#minimizing-banding-in-random-aperture" title="Permalink to this headline">¶</a></h2>
<p>The random aperture load distribution can be very closely approximated by the binomial distribution.
The distribution represents the likelihood that a server will have a given number of clients, where
a client represents a uniform amount of load. A binomial distribution can be characterized by two
parameters, n and p, where n is the number of edges (trials) between the clients and the servers,
and p is the probability that a given server is chosen when a client chooses an edge. In a
client/server relationship,</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>n = (# client) * (# remote peers per client)
p = 1 / (# servers)
</pre></div>
</div>
<p>The distribution can be used as a guide for how to choose the number of remote peers per client.
Since the binomial distribution starts to turn Gaussian as the increase the number of trials,
properties of Gaussian distributions can be used to reason about the binomial distribution (note
that it’s worth checking that the graph looks reasonably Gaussian before using these rules of
thumb). In a Gaussian distribution, approximately 1/3 of the servers will be &lt; (mean - stddev), and
approximately 1/3 of the servers will be &gt; (mean + stddev). This can be used to extrapolate the
distribution of connections per host. Wolfram Alpha is a good resource for visualizing the behavior
of a binomial distribution for different parameters.</p>
</section>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>Let’s say that there exists a service called “Brooklyn” that has 1000 nodes in its cluster which is
configured to use the aperture load balancer to connect with a service consisting of 5000 nodes
called “GadgetDuck”. The goal is to pick the minimum number of connections that will result in a
~20% or less difference between the low and high load bands. As an initial value for exploring the
distributions, the asymptotic value of 1 is used as the aperture size. Using <a class="reference external" href="https://www.wolframalpha.com/input/?i=binomial+distribution(5000,+0.001)">Wolfram Alpha</a>, the mean is found
to be 5, and the stddev will be 2.5. This distribution is too wide to satisfy the 20% difference
requirement, so the next step is to increase the number of remote peers to 10. <a class="reference external" href="https://www.wolframalpha.com/input/?i=binomial+distribution(50000,+0.001)">Wolfram
Alpha</a> computes the mean
and stdev of the new distribution to be 50 and 7, respectively, which is still too wide. <a class="reference external" href="https://www.wolframalpha.com/input/?i=binomial+distribution(500000,+0.001)">A third
attempt</a> using 100
remote peers yields a mean of 500 and stddev of 22 which is within the requirements. Thus, an
aperture size of 100 or more will satisfy the load banding requirement. Further iterations
could be used to shrink the aperture size to a value in the range (10, 100] that still satisfies
the banding requirement, if so desired.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="../index.html">
  <img class="logo" src="../_static/logo_small.png" alt="Logo"/>
</a></p><a href="index.html"><h3>Finagle</h3></a>
<p>
  Finagle is a network stack for distributed systems.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://github.com/twitter/finagle">Finagle @ GitHub</a></li>
  <li><a href="https://github.com/twitter/finagle/issues">Issue Tracker</a></li>
</ul>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Random Aperture</a><ul>
<li><a class="reference internal" href="#minimizing-banding-in-random-aperture">Minimizing Banding in Random Aperture</a></li>
<li><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">&copy; Copyright 2024 Twitter, Inc.</div>
  
  </body>
</html>