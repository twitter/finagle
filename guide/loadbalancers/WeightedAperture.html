
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Weighted Aperture &#8212; Finagle 24.2.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/finagle.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">Finagle</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Weighted Aperture</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="weighted-aperture">
<h1>Weighted Aperture<a class="headerlink" href="#weighted-aperture" title="Permalink to this headline">¶</a></h1>
<p>The weighted “flavor” of aperture load balancers was introduced as a means to
offer balancers more control over balancing traffic. Traditional aperture
balancers require preprocessing to generate groups of equally weighted
endpoints, allowing the load balancer to send the same proportion of traffic
to each endpoint. Weighted aperture balancers, on the other hand, need no pre-processing.
They have knowledge of endpoint weights and send traffic proportionally. Apart from
allowing these balancers to behave more dynamically, this limits the number of connections
going to any single instance. For example, an endpoint with a unique weight, no matter
how small, would, in traditional balancers, end up in its own weight class alone,
therefore appearing in every aperture and receiving many connections. With weighted
aperture, that endpoint would simply occupy a smaller portion of the ring and
therefore appear in fewer apertures.
Though both Random and Deterministic Aperture can behave as weighted aperture balancers,
their algorithms are slightly modified to account for this additional information.</p>
<section id="weighted-deterministic-aperture">
<h2>Weighted Deterministic Aperture<a class="headerlink" href="#weighted-deterministic-aperture" title="Permalink to this headline">¶</a></h2>
<p>With additional weight information, the ring model is no longer a simple abstraction
for selecting endpoints to send traffic to. If endpoints can handle differing levels
of traffic, they can’t take up equal portions of the ring. In other words, the
“fair die” feature of the ring is abandoned. The ring in the examples above might look
something like the following.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/waperturering.png"><img alt="../_images/waperturering.png" src="../_images/waperturering.png" style="width: 60%;" /></a>
</figure>
<p>Without some computation, it’s not immediately obvious which endpoints are within
the aperture, nor is it easy to determine which endpoint a value between 0 and 1
corresponds to, making random selection within an aperture equally difficult.</p>
<p>Rather than representing the deterministic subsetting for weighted aperture as
overlapping rings, we shift to a two dimensional model that represent the nodes
within a given aperture as reorganized areas.</p>
<figure class="align-center">
<img alt="../_images/ring-to-area.gif" src="../_images/ring-to-area.gif" />
</figure>
<p>Mathematically, this computation is completed via <a class="reference external" href="https://github.com/twitter/finagle/blob/develop/finagle-core/src/main/scala/com/twitter/finagle/util/Drv.scala">c.t.f.util.Drv</a>.
By adding a second dimension, we’re able to equalize the widths of each endpoint while
maintaining their weights in the form of areas. For example, an endpoint of weight 0.5
would, rather than having a length around a ring of 0.5, have a width of 1 and a height
of 0.5, resulting in an overall area of 0.5. Crucially, this reorganization retains
the O(1) complexity of the original ring model by making indexing simple.</p>
<figure class="align-center">
<img alt="../_images/waperturearea.png" src="../_images/waperturearea.png" />
</figure>
<p>For more information on how determinism is maintained in weighted aperture balancers,
check out <a class="reference external" href="https://github.com/twitter/finagle/blob/develop/finagle-core/src/main/scala/com/twitter/finagle/util/Drv.scala">c.t.f.util.Drv</a>
and <a class="reference external" href="https://www.keithschwarz.com/darts-dice-coins/">this explanation</a> of the probabilistic models.</p>
</section>
<section id="weighted-random-aperture">
<h2>Weighted Random Aperture<a class="headerlink" href="#weighted-random-aperture" title="Permalink to this headline">¶</a></h2>
<p>Similarly for random aperture, the problem of identifying endpoints when they’re each
of different widths (or lengths) isn’t as simple in the weighted pathway. As an added
complexity, endpoints in random apertures are occasionally reorganized to ensure
healthy nodes are more often within a given aperture. Since building the Drv is costly,
rebuilding it at unknown intervals is unreasonable. Therefore, for weighted random aperture,
we still arrange the endpoints along a ring bounded betweeen 0 and 1 but instead use binary
search to determine which endpoint is selected by P2C. It’s important
to note that this change results in a shift from O(1) endpoint selection to O(log(N)) selection
complexity. This is a compromise made to ensure that the overall behavior of Random Aperture
is maintained.</p>
</section>
<section id="key-metrics">
<h2>Key Metrics<a class="headerlink" href="#key-metrics" title="Permalink to this headline">¶</a></h2>
<p>The key metrics for weighted apertures are the same as their traditional counterparts, with one
exception. To determine if you’re running a weighted balancer, check for the <cite>_weighted</cite> suffix
in the <cite>$clientName/loadbalancer/algorithm</cite> metric.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="../index.html">
  <img class="logo" src="../_static/logo_small.png" alt="Logo"/>
</a></p><a href="index.html"><h3>Finagle</h3></a>
<p>
  Finagle is a network stack for distributed systems.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://github.com/twitter/finagle">Finagle @ GitHub</a></li>
  <li><a href="https://github.com/twitter/finagle/issues">Issue Tracker</a></li>
</ul>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Weighted Aperture</a><ul>
<li><a class="reference internal" href="#weighted-deterministic-aperture">Weighted Deterministic Aperture</a></li>
<li><a class="reference internal" href="#weighted-random-aperture">Weighted Random Aperture</a></li>
<li><a class="reference internal" href="#key-metrics">Key Metrics</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">&copy; Copyright 2024 Twitter, Inc.</div>
  
  </body>
</html>