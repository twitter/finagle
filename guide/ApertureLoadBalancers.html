
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Aperture Load Balancers &#8212; Finagle 21.11.0 documentation</title>
    <link rel="stylesheet" href="_static/finagle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Servers" href="Servers.html" />
    <link rel="prev" title="Configuration" href="Configuration.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="Servers.html" title="Servers"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Configuration.html" title="Configuration"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Finagle</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="aperture-load-balancers">
<span id="id1"></span><h1>Aperture Load Balancers<a class="headerlink" href="#aperture-load-balancers" title="Permalink to this headline">¶</a></h1>
<p>The family of aperture load balancers are characterized by their selection of a subset of backend
hosts with which to direct traffic to. This stands in contrast to <a class="reference internal" href="Clients.html#p2c-least-loaded"><span class="std std-ref">P2C</span></a>
which establishes connections to all available backends. In Finagle, there are two aperture load
balancers, random aperture and deterministic aperture which differ in how they select the subset of
hosts.</p>
<div class="section" id="random-aperture">
<h2>Random Aperture<a class="headerlink" href="#random-aperture" title="Permalink to this headline">¶</a></h2>
<p>The Random Aperture load balancer was developed to reduce the number of connections that clients
will establish when talking to large clusters. It does so by selecting a random subset of backends
to talk do under normal conditions with some slight changes under extraordinary conditions. This a
positive effect for both clients and servers by reducing the connections between them but comes with
the cost of load banding. Because clients choose which servers they talk randomly, it’s possible
that some choices of the minimum number of peers to talk to will cause some servers to have more
clients than others. Assuming that clients in a cluster produce the same amount of load, this means
that some servers will have more or less load than others. This makes it harder to reason about a
clusters overall capacity, overload scenarios, and failure modes because servers are no longer
uniformly loaded.</p>
<div class="figure align-center" id="id3">
<img alt="_images/random-aperture.png" src="_images/random-aperture.png" />
<p class="caption"><span class="caption-text">Service A connecting to Service B using random aperture. The number of connections are reduced
but there is an uneven number of connections per service B host due to the statistical nature of
service A picking hosts randomly.</span></p>
</div>
<div class="section" id="minimizing-banding-in-random-aperture">
<h3>Minimizing Banding in Random Aperture<a class="headerlink" href="#minimizing-banding-in-random-aperture" title="Permalink to this headline">¶</a></h3>
<p>The random aperture load distribution can be very closely approximated by the binomial distribution.
The distribution represents the likelihood that a server will have a given number of clients, where
a client represents a uniform amount of load. A binomial distribution can be characterized by two
parameters, n and p, where n is the number of edges (trials) between the clients and the servers,
and p is the probability that a given server is chosen when a client chooses an edge. In a
client/server relationship,</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>n = (# client) * (# remote peers per client)
p = 1 / (# servers)
</pre></div>
</div>
<p>The distribution can be used as a guide for how to choose the number of remote peers per client.
Since the binomial distribution starts to turn Gaussian as the increase the number of trials,
properties of Gaussian distributions can be used to reason about the binomial distribution (note
that it’s worth checking that the graph looks reasonably Gaussian before using these rules of
thumb). In a Gaussian distribution, approximately 1/3 of the servers will be &lt; (mean - stddev), and
approximately 1/3 of the servers will be &gt; (mean + stddev). This can be used to extrapolate the
distribution of connections per host. Wolfram Alpha is a good resource for visualizing the behavior
of a binomial distribution for different parameters.</p>
</div>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<p>Let’s say that there exists a service called “Brooklyn” that has 1000 nodes in its cluster which is
configured to use the aperture load balancer to connect with a service consisting of 5000 nodes
called “GadgetDuck”. The goal is to pick the minimum number of connections that will result in a
~20% or less difference between the low and high load bands. As an initial value for exploring the
distributions, the asymptotic value of 1 is used as the aperture size. Using <a class="reference external" href="https://www.wolframalpha.com/input/?i=binomial+distribution(5000,+0.001)">Wolfram Alpha</a>, the mean is found
to be 5, and the stddev will be 2.5. This distribution is too wide to satisfy the 20% difference
requirement, so the next step is to increase the number of remote peers to 10. <a class="reference external" href="https://www.wolframalpha.com/input/?i=binomial+distribution(50000,+0.001)">Wolfram
Alpha</a> computes the mean
and stdev of the new distribution to be 50 and 7, respectively, which is still too wide. <a class="reference external" href="https://www.wolframalpha.com/input/?i=binomial+distribution(500000,+0.001)">A third
attempt</a> using 100
remote peers yields a mean of 500 and stddev of 22 which is within the requirements. Thus, an
aperture size of 100 or more will satisfy the load banding requirement. Further iterations
could be used to shrink the aperture size to a value in the range (10, 100] that still satisfies
the banding requirement, if so desired.</p>
</div>
</div>
<div class="section" id="deterministic-aperture">
<h2>Deterministic Aperture<a class="headerlink" href="#deterministic-aperture" title="Permalink to this headline">¶</a></h2>
<p>Deterministic aperture is a refinement of random aperture that has better load
distribution and connection count properties. Like random aperture, deterministic
aperture reduces the overhead of clients for both clients and the servers they talk to
by only talking to a subset of service instances, unlike P2C which lets the client pick
from any replica in the serverset. However, unlike the classic aperture implementation,
it does so using a deterministic algorithm which distributes load evenly across service
instances, reducing the phenomena of load banding which is inherent to the statistical
approach employed by random aperture. This facilitates a further reduction in necessary
connections and manual configuration. Deterministic Aperture is the default load balancer
at Twitter.</p>
<p><em>Service B RPS during a rolling restart of service A which changed the load balancer from random
aperture to determinstic aperture</em></p>
<div class="figure align-center" id="id4">
<img alt="_images/t-to-g-daperturerolloutrps.png" src="_images/t-to-g-daperturerolloutrps.png" />
<p class="caption"><span class="caption-text">The variance in requests per second (RPS) is significantly diminished after the service A deploy
due to the deterministic load distribution.</span></p>
</div>
<p><em>Connections from service A to service B during a rolling restart of service A which changed the
load balancer from random aperture to determinstic aperture</em></p>
<div class="figure align-center" id="id5">
<img alt="_images/t-to-g-daperturerolloutconnections.png" src="_images/t-to-g-daperturerolloutconnections.png" />
<p class="caption"><span class="caption-text">The total number of connections from A to B was significantly reduced.</span></p>
</div>
<div class="section" id="deterministic-subsetting">
<h3>Deterministic Subsetting<a class="headerlink" href="#deterministic-subsetting" title="Permalink to this headline">¶</a></h3>
<p>Deterministic aperture combines information about both the backend cluster as well as the
cluster information for the service at hand and partitions connections to backends in a
way that favors equal load and minimal connections (with a lower bound of 12 to satisfy
common concurrency and redundancy needs). It does this by letting each member of a cluster
compute a subset of weighted backends to talk to based on information about each cluster.
This can be visually represented as a pair of overlapping rings: The outer ring, or “peer ring”,
represents the cluster of peers (Service A) which are acting in concert to offer load to the
“destination ring” which represents the cluster of backends (Service B).</p>
<div class="figure align-center" id="id6">
<img alt="_images/daperture-ringdiagram1.png" src="_images/daperture-ringdiagram1.png" />
<p class="caption"><span class="caption-text">Each instance of Service A determines which “slice” of the backend ring to talk to and
directs its traffic to those specific instances.</span></p>
</div>
<div class="figure align-center" id="id7">
<img alt="_images/daperture-ringdiagram2.png" src="_images/daperture-ringdiagram2.png" />
<p class="caption"><span class="caption-text">Since each client instance is doing the same thing, except picking the slice that belongs
to them, we can evenly load the backend cluster (Service B).
Note that this requires the load balancer to respect the continuous ring representation
since peer slices may cover fractional portions of the destination ring.</span></p>
</div>
</div>
<div class="section" id="traffic-patterns">
<h3>Traffic Patterns<a class="headerlink" href="#traffic-patterns" title="Permalink to this headline">¶</a></h3>
<p>The deterministic aperture model, and subsetting models in general, works well when the
traffic pattern between service A and B is “smooth” meaning that for each instance of
Service A the request pattern doesn’t consists of significant bursts with respect to the
average request rate and that requests are roughly equal cost, both in resource usage of
the backend and in terms of latency. If the traffic pattern is characterized by
large bursts of traffic, say invalidation of a cache based on a timer, then small chunks
of the ring will end up extremely loaded for the duration of the burst while other slices
may be essentially idle. Under those conditions the P2C load balancer may be more
appropriate so the entire backend cluster can absorb the large bursts coming from instances
of Service A.</p>
</div>
<div class="section" id="peer-information">
<h3>Peer Information<a class="headerlink" href="#peer-information" title="Permalink to this headline">¶</a></h3>
<p>In order for deterministic aperture to be deterministic it needs to know some additional
information. This is important for computing the “slice” of backends that the load balancer
will utilize. To know how large of slice to use the client needs information about both the
backends, or the serverset, and it needs to know some information about its peers, also
known as the peerset. The peerset is the only new information needed since knowing about
the backends is a requirement for any client side load balancer. In regard to the peerset
we need two different pieces of information:</p>
<ul class="simple">
<li>How many replicas are there in the peerset. This is used to compute how large each clients
slice of the backends will be.</li>
<li>What is the position of this instance in the peerset. This is required to compute which
slice that this client should take.</li>
</ul>
<p>This information can be configured in the <a class="reference external" href="https://github.com/twitter/finagle/blob/develop/finagle-core/src/main/scala/com/twitter/finagle/loadbalancer/aperture/ProcessCoordinate.scala">ProcessCoordinate</a>
object by setting the processes instance number and the total number of instances. The current
implementation requires that all instances in the cluster have unique and contiguous instance id’s
starting at 0.</p>
</div>
<div class="section" id="key-metrics">
<h3>Key Metrics<a class="headerlink" href="#key-metrics" title="Permalink to this headline">¶</a></h3>
<p>Success rates and exceptions should not be affected by the new load balancer. Other
important metrics to consider are request latency and connection count.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$clientName/request_latency_ms.p*

$clientName/connections

$clientName/loadbalancer/vector_hash

finagle/aperture/coordinate
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="index.html">
  <img class="logo" src="_static/logo_small.png" alt="Logo"/>
</a></p><a href="index.html"><h3>Finagle</h3></a>
<p>
  Finagle is a network stack for distributed systems.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://github.com/twitter/finagle">Finagle @ GitHub</a></li>
  <li><a href="https://github.com/twitter/finagle/issues">Issue Tracker</a></li>
</ul>
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Aperture Load Balancers</a><ul>
<li><a class="reference internal" href="#random-aperture">Random Aperture</a><ul>
<li><a class="reference internal" href="#minimizing-banding-in-random-aperture">Minimizing Banding in Random Aperture</a></li>
<li><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deterministic-aperture">Deterministic Aperture</a><ul>
<li><a class="reference internal" href="#deterministic-subsetting">Deterministic Subsetting</a></li>
<li><a class="reference internal" href="#traffic-patterns">Traffic Patterns</a></li>
<li><a class="reference internal" href="#peer-information">Peer Information</a></li>
<li><a class="reference internal" href="#key-metrics">Key Metrics</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="Configuration.html" title="previous chapter">Configuration</a></li>
      <li>Next: <a href="Servers.html" title="next chapter">Servers</a></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">&copy; Copyright 2021 Twitter, Inc.</div>
  
  </body>
</html>