
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Signaling Failure within Finagle &#8212; Finagle 24.2.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/finagle.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Changelog" href="../changelog.html" />
    <link rel="prev" title="Twitter Futures" href="Futures.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../changelog.html" title="Changelog"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Futures.html" title="Twitter Futures"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Finagle</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Signaling Failure within Finagle</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="signaling-failure-within-finagle">
<h1>Signaling Failure within Finagle<a class="headerlink" href="#signaling-failure-within-finagle" title="Permalink to this headline">¶</a></h1>
<p>For a combination of historical and practical reasons, there are many ways to
signal an unsuccessful response in Finagle. When extending Finagle, it is
important to use the correct signaling mechanisms.</p>
<p>For more information on how these are presented to users outside of Finagle, see
the <a class="reference internal" href="../UnsuccessfulResponses.html"><span class="doc">Unsuccessful Responses</span></a> page in the User’s Guide.</p>
<section id="history">
<h2>History<a class="headerlink" href="#history" title="Permalink to this headline">¶</a></h2>
<p>Historically, Finagle relied exclusively on a hierarchy of classes of exceptions
defined in <a class="reference external" href="https://github.com/twitter/finagle/blob/release/finagle-core/src/main/scala/com/twitter/finagle/Exceptions.scala">Exceptions.scala</a>, with
each exception corresponding to a specific problem. Pattern matching on
the exception type was used to classify the exceptions and make decisions about
how to handle them. As the number of exceptions grew, pattern matching became
unwieldy and <cite>Failures</cite>, were introduced as uniform way for Finagle to signal
failure internally. Failures are more general and the successor to ad-hoc
Exceptions. They are composable, immutable, and allow us to send signals across
process boundaries.</p>
<p>However, when fleshing out Finagle’s back pressure strategy, it became useful
for exceptions other than just <cite>Failure</cite> to also be able to be flagged with
various attributes that propagate across service boundaries. In order to
accomplish this, the <a class="reference external" href="https://github.com/twitter/finagle/blob/release/finagle-core/src/main/scala/com/twitter/finagle/FailureFlags.scala">FailureFlags</a>
trait was introduced. <cite>FailureFlags</cite> can be applied to any <cite>Throwable</cite>, which
simplifies the migration strategy as the type of <cite>Throwable</cite> no longer has to
change.</p>
<p>Currently, a <cite>Failure</cite> can be thought of as a “Finagle runtime exception” as
it contains no type-based information. <cite>Failure</cite> provides a convenient API for
building <cite>FailureFlag</cite>-style exceptions, but should not be used for inspection.</p>
</section>
<section id="creating-exceptions-with-failureflags">
<h2>Creating exceptions with FailureFlags<a class="headerlink" href="#creating-exceptions-with-failureflags" title="Permalink to this headline">¶</a></h2>
<p>Any new module should ensure that the exceptions it creates have <cite>FailureFlags</cite>.
This can be done by creating a new class that extends <cite>FailureFlags</cite> or by using
convenience methods in
<a class="reference external" href="https://github.com/twitter/finagle/blob/release/finagle-core/src/main/scala/com/twitter/finagle/Failure.scala">Failure.scala</a>.</p>
<p><strong>If the class name of the exception is helpful to users</strong> use a custom
exception class that extends <cite>FailureFlags</cite>. The class name will show up in logs
and stats. This is preferred.</p>
<p><strong>If class name of the exception is unimportant or it is truly a runtime-exception
type error</strong>, creating a new <cite>Failure</cite> with flags set correctly is appropriate.</p>
<p>Responding with an arbitrary Throwable or Exception is not
recommended as they will be converted generic exceptions. For instance,
Thrift will convert them to <cite>TApplicationExceptions</cite>.</p>
</section>
<section id="examining-and-modifying-failureflags">
<h2>Examining and Modifying FailureFlags<a class="headerlink" href="#examining-and-modifying-failureflags" title="Permalink to this headline">¶</a></h2>
<p>To inspect a <cite>Throw</cite> response for flags, pattern match against the FailureFlags trait.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finagle</span><span class="p">.</span><span class="nc">FailureFlags</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">util</span><span class="p">.</span><span class="nc">Throw</span>

<span class="n">response</span> <span class="k">match</span> <span class="p">{</span>
  <span class="k">case</span> <span class="nc">Throw</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="nc">FailureFlags</span><span class="p">[</span><span class="n">_</span><span class="p">])</span> <span class="k">if</span> <span class="n">f</span><span class="p">.</span><span class="n">isFlagged</span><span class="p">(</span><span class="nc">FailureFlags</span><span class="p">.</span><span class="n">$FLAG</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="c1">// Logic here.</span>
  <span class="k">case</span> <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p><cite>FailureFlags</cite> responses should be immutable. All of the convenience methods for
flagging and unflagging make copies. Use these methods to modify flags.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">finagle</span><span class="p">.</span><span class="nc">FailureFlags</span>
<span class="k">import</span> <span class="nn">com</span><span class="p">.</span><span class="nn">twitter</span><span class="p">.</span><span class="nn">util</span><span class="p">.</span><span class="nc">Throw</span>

<span class="c1">// Flag a response as &quot;nonRetryable&quot;</span>
<span class="n">response</span> <span class="k">match</span> <span class="p">{</span>
  <span class="k">case</span> <span class="nc">Throw</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="nc">FailureFlags</span><span class="p">[</span><span class="n">_</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="nc">Future</span><span class="p">.</span><span class="n">exception</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">asNonRetryable</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="failureflags-and-failures-outside-of-finagle">
<h2>FailureFlags and Failures outside of Finagle<a class="headerlink" href="#failureflags-and-failures-outside-of-finagle" title="Permalink to this headline">¶</a></h2>
<p>In a typically-configured client, the <a class="reference external" href="https://github.com/twitter/finagle/blob/release/finagle-core/src/main/scala/com/twitter/finagle/Failure.scala">ProcessFailures</a> filter will unwrap (See <cite>Failure#unwrap</cite>)
Failures and mask out <cite>FailureFlags</cite> that are unsafe to pass along to users.</p>
<p>Unwrapping a <cite>Failure</cite> will transform the <cite>Failure</cite> into whatever Throwable it
had wrapped, discarding any additional information carried by the <cite>Failure</cite>. The
reason for this unwrapping is because of the large API burden of moving over to
<cite>Failure</cite> completely. By switching to a <cite>FailureFlags</cite> trait, this problem is
avoided.</p>
<p>If a Failure does not wrap anything, the <cite>ProcessFailures</cite> filter will only mask
off unsafe <cite>FailureFlags</cite>.</p>
</section>
<section id="propagating-responses">
<h2>Propagating Responses<a class="headerlink" href="#propagating-responses" title="Permalink to this headline">¶</a></h2>
<p>There’s some nuance as to how <cite>FailureFlags</cite> and unflagged exceptions traverse
client/service boundaries and differ across protocols. These tables cover
how unsuccessful responses propagate from service to client over the two most
common protocols: HTTP and ThriftMux. The columns indicate how the response is
transformed along the way.</p>
<section id="thriftmux">
<h3>ThriftMux<a class="headerlink" href="#thriftmux" title="Permalink to this headline">¶</a></h3>
<p>ThriftMux will currently pass the following <cite>FailureFlags</cite>: <cite>Rejected</cite>,
<cite>Retryable</cite>, <cite>NonRetryable</cite>. See <a class="reference external" href="https://github.com/twitter/finagle/blob/release/finagle-mux/src/main/scala/com/twitter/finagle/mux/transport/MuxFailure.scala">MuxFailure.scala</a>.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Cause</p></th>
<th class="head"><p>Finagle (as Throw)</p></th>
<th class="head"><p>ThriftMux</p></th>
<th class="head"><p>Mux</p></th>
<th class="head"><p>Client Sees (as Throw)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><cite>SomeException(message)</cite> raised in handling request</p></td>
<td><p><cite>SomeException</cite></p></td>
<td><p><cite>TApplicationException</cite></p></td>
<td><p><cite>RdispatchOk</cite></p></td>
<td><p><cite>TApplicationException(message)</cite></p></td>
</tr>
<tr class="row-odd"><td><p><cite>Failure.rejected(message)</cite></p></td>
<td><p><cite>Failure</cite></p></td>
<td><p><cite>Failure</cite></p></td>
<td><p><cite>RdispatchNack</cite></p></td>
<td><p><cite>Failure(message)</cite> flagged <cite>Rejected</cite> &amp; <cite>NonRetryable</cite></p></td>
</tr>
<tr class="row-even"><td><p>any <cite>Throwable with HasFailureFlags</cite></p></td>
<td><p><cite>T: HasFailureFlags</cite></p></td>
<td><p><cite>T: HasFailureFlags</cite></p></td>
<td><p><cite>RdispatchError</cite></p></td>
<td><p><cite>Failure(throwable.toString)</cite> with supported <cite>FailureFlags</cite></p></td>
</tr>
</tbody>
</table>
<p><cite>Failure.rejected</cite> creates a <cite>Failure</cite> with <cite>Rejected</cite> and <cite>Retryable</cite> flags.</p>
<p>If a custom <cite>Throwable</cite> is used, its message and <cite>FailureFlags</cite> (if any) will
propagate but it will be converted in to a <cite>Failure</cite>. Any other information,
such as stack traces, will be discarded. Due to Finagle’s asynchronous nature,
stack traces are not particularly useful. Instead Finagle provides built in
support for distributed tracing systems.</p>
<p>When sending these responses across service boundaries, <cite>toString</cite> is called on
each hop. This means that messages will appear like
“Failure(Failure(Failure(Underlying cause… ” when logged. This may change in
the future.</p>
</section>
<section id="http">
<h3>HTTP<a class="headerlink" href="#http" title="Permalink to this headline">¶</a></h3>
<p>Http will pass the flag <cite>Rejected</cite> (a retryable nack) or a combination of <cite>Rejected</cite>
and <cite>NonRetryable</cite> (a nonretryable nack) via headers. HTTP will completely discard
any information (stack trace, message, etc) except for the flags. See
<a class="reference external" href="https://github.com/twitter/finagle/blob/release/finagle-base-http/src/main/scala/com/twitter/finagle/http/filter/HttpNackFilter.scala">HttpNackFilter.scala</a></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Cause</p></th>
<th class="head"><p>Finagle (as Throw)</p></th>
<th class="head"><p>Http</p></th>
<th class="head"><p>Client Sees (as Throw)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><cite>SomeException(message)</cite> raised in handling request</p></td>
<td><p><cite>SomeException</cite></p></td>
<td><p><cite>500 Internal Server Error</cite></p></td>
<td><p><cite>Return(Http.Response(500 w/ message))</cite></p></td>
</tr>
<tr class="row-odd"><td><p>any <cite>Throwable with HasFailureFlags</cite> flagged <cite>Rejected</cite> and <cite>NonRetryable</cite></p></td>
<td><p><cite>T: HasFailureFlags</cite></p></td>
<td><p><cite>503 Service Unavailable</cite> w/ ‘finagle-http-nack’ header</p></td>
<td><p><cite>Failure</cite> flagged <cite>Rejected</cite> and <cite>NonRetryable</cite></p></td>
</tr>
<tr class="row-even"><td><p>any <cite>Throwable with HasFailureFlags</cite> flagged <cite>Rejected</cite></p></td>
<td><p><cite>T: HasFailureFlags</cite></p></td>
<td><p><cite>503 Service Unavailable</cite> w/ ‘finagle-http-nonretryable-nack’ header</p></td>
<td><p><cite>Failure</cite> flagged <cite>Rejected</cite> and <cite>NonRetryable</cite></p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="../index.html">
  <img class="logo" src="../_static/logo_small.png" alt="Logo"/>
</a></p><a href="index.html"><h3>Finagle</h3></a>
<p>
  Finagle is a network stack for distributed systems.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://github.com/twitter/finagle">Finagle @ GitHub</a></li>
  <li><a href="https://github.com/twitter/finagle/issues">Issue Tracker</a></li>
</ul>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Signaling Failure within Finagle</a><ul>
<li><a class="reference internal" href="#history">History</a></li>
<li><a class="reference internal" href="#creating-exceptions-with-failureflags">Creating exceptions with FailureFlags</a></li>
<li><a class="reference internal" href="#examining-and-modifying-failureflags">Examining and Modifying FailureFlags</a></li>
<li><a class="reference internal" href="#failureflags-and-failures-outside-of-finagle">FailureFlags and Failures outside of Finagle</a></li>
<li><a class="reference internal" href="#propagating-responses">Propagating Responses</a><ul>
<li><a class="reference internal" href="#thriftmux">ThriftMux</a></li>
<li><a class="reference internal" href="#http">HTTP</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="Futures.html" title="previous chapter">Twitter Futures</a></li>
      <li>Next: <a href="../changelog.html" title="next chapter">Changelog</a></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">&copy; Copyright 2024 Twitter, Inc.</div>
  
  </body>
</html>